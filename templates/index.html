<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Home - Gestor de Tarefas</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container">
            <a class="navbar-brand" href="{{ url_for('auth.index') }}">Gestor de Tarefas</a>
            <div class="navbar-nav ms-auto">
                {% if user %}
                    <span class="navbar-text me-3">Bem-vindo, {{ user.username }}!</span>
                    <a class="nav-link" href="{{ url_for('auth.change_password') }}">Change Password</a>
                    <a class="nav-link" href="{{ url_for('auth.logout') }}">Logout</a>
                {% else %}
                    <a class="nav-link" href="{{ url_for('auth.login') }}">Login</a>
                    <a class="nav-link" href="{{ url_for('auth.register') }}">Register</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <div class="container mt-5">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    {% if category == 'error' %}
                        <div class="alert alert-danger alert-dismissible fade show" role="alert">
                    {% elif category == 'success' %}
                        <div class="alert alert-success alert-dismissible fade show" role="alert">
                    {% elif category == 'warning' %}
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                    {% elif category == 'info' %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {% else %}
                        <div class="alert alert-info alert-dismissible fade show" role="alert">
                    {% endif %}
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container ml-5">
        <table class="table table-hover">
            <thead>
                <tr>
                    <th scope="col">Descrição</th>
                    <th scope="col">Local</th>
                    <th scope="col">Setor</th>
                    <th scope="col">Criado por</th>
                    <th scope="col">Solicitante</th>
                    <th scope="col">Atendente</th>
                    <th scope="col">Prioridade</th>
                    <th scope="col">Data criada</th>
                    <th scope="col">Prazo</th>
                    <th scope="col">Status</th>
                    {% if user.tipo == 1 %}
                        <th scope="col">Ações</th>
                    {% endif %}
                    <th scope="col"><a href="{{ url_for('auth.new_task') }}" class="btn btn-primary btn-sm">Criar</a></th>
                </tr>
            </thead>
            <tbody>
                {% if atividades %}
                    {% for atividade in atividades %}
                        <tr data-atividade-id="{{ atividade.id }}">
                            <td>{{ atividade.descricao }}</td>
                            <td>{{ atividade.local or 'Não especificado' }}</td>
                            <td>{{ atividade.setor or '-' }}</td>
                            <td>{{ atividade.criado_por_nome }}</td>
                            <td>{{ atividade.solicitante or 'Não atribuído' }}</td>
                            <td>{{ atividade.atendente or '-' }}</td>
                            <td>
                                {% if atividade.prioridade == 'Baixa' %}
                                    <span class="badge bg-success">{{ atividade.prioridade }}</span>
                                {% elif atividade.prioridade == 'Média' %}
                                    <span class="badge bg-info">{{ atividade.prioridade }}</span>
                                {% elif atividade.prioridade == 'Alta' %}
                                    <span class="badge bg-warning">{{ atividade.prioridade }}</span>
                                {% elif atividade.prioridade == 'Crítica' %}
                                    <span class="badge bg-danger">{{ atividade.prioridade }}</span>
                                {% endif %}
                            </td>
                            <td>{{ atividade.data_criada.strftime('%d/%m/%Y') if atividade.data_criada else '' }}</td>
                            <td>{{ atividade.prazo.strftime('%d/%m/%Y') if atividade.prazo else 'Não definido' }}</td>
                            <td>
                                {% if atividade.status == 'Pendente' %}
                                    <span class="badge bg-warning">{{ atividade.status }}</span>
                                {% elif atividade.status == 'Em andamento' %}
                                    <span class="badge bg-primary">{{ atividade.status }}</span>
                                {% elif atividade.status == 'Concluída' %}
                                    <span class="badge bg-success">{{ atividade.status }}</span>
                                {% elif atividade.status == 'Cancelada' %}
                                    <span class="badge bg-danger">{{ atividade.status }}</span>
                                {% endif %}
                            </td>
                            {% if user.tipo == 1 %}
                                <td>
                                    {% if atividade.status == 'Pendente' %}
                                        <a href="{{ url_for('auth.update_status', atividade_id=atividade.id, new_status='Em andamento') }}" class="btn btn-sm btn-primary">Iniciar</a>
                                    {% elif atividade.status == 'Em andamento' %}
                                        <a href="{{ url_for('auth.update_status', atividade_id=atividade.id, new_status='Concluída') }}" class="btn btn-sm btn-success">Concluir</a>
                                    {% elif atividade.status == 'Concluída' %}
                                        <a href="#" class="btn btn-sm btn-secondary disabled">Concluída</a>
                                    {% endif %}
                                    <a href="{{ url_for('auth.delete_atividade', atividade_id=atividade.id) }}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja excluir esta atividade? Esta ação não pode ser desfeita.')">Excluir</a>
                                </td>
                            {% endif %}
                        </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="11" class="text-center text-muted">
                            <p class="my-3">Nenhuma atividade encontrada.</p>
                            <a href="{{ url_for('auth.new_task') }}" class="btn btn-primary">Criar primeira atividade</a>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    {% if user and (user.tipo == 1 or (user.tipo == 2 and user_setor)) %}
    <!-- WebSocket for real-time notifications -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.2/socket.io.js"></script>
    <script>
        // Initialize WebSocket connection
        const socket = io();
        const userTipo = {{ user.tipo }};
        const userSetor = '{{ user_setor if user_setor else "" }}';
        
        // Connect and join appropriate room based on user type
        socket.on('connect', function() {
            console.log('Connected to WebSocket');
            
            if (userTipo === 1) {
                // Admin user joins admin room
                socket.emit('join_admin_room');
                console.log('Joined admin room');
            } else if (userTipo === 2 && userSetor) {
                // Regular user joins sector room
                socket.emit('join_setor_room', {setor: userSetor});
                console.log('Joined sector room:', userSetor);
            }
        });
        
        // Handle new task notifications for admins (tipo==1)
        socket.on('new_task_notification', function(data) {
            if (userTipo === 1) {
                console.log('New task notification received:', data);
                
                // Play beep sound
                playBeep(800, 0.5); // High pitched beep for new tasks
                
                // Show browser notification if permission granted
                if (Notification.permission === 'granted') {
                    new Notification('Nova Tarefa Criada!', {
                        body: data.message,
                        icon: '/static/images/brasao.svg'
                    });
                }
                
                // Show Bootstrap toast notification
                showToast('Nova Tarefa!', data.message, 'success');
                
                // Add new task to the table without refreshing
                addNewTaskToTable(data);
            }
        });
        
        // Handle activity update notifications for tipo==2 users
        socket.on('activity_update_notification', function(data) {
            if (userTipo === 2) {
                console.log('Activity update notification received:', data);
                
                // Play beep sound
                playBeep(600, 0.3); // Lower pitched beep for updates
                
                // Show browser notification if permission granted
                if (Notification.permission === 'granted') {
                    new Notification('Atividade Atualizada!', {
                        body: data.message,
                        icon: '/static/images/brasao.svg'
                    });
                }
                
                // Show Bootstrap toast notification
                showToast('Atividade Atualizada!', data.message, 'info');
                
                // Update the task status in the table without refreshing
                updateTaskInTable(data);
            }
        });
        
        // Function to play beep sound
        function playBeep(frequency = 700, duration = 0.4) {
            try {
                // Create AudioContext
                const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                
                // Create oscillator
                const oscillator = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                oscillator.frequency.value = frequency;
                oscillator.type = 'sine';
                
                gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
                gainNode.gain.linearRampToValueAtTime(0.2, audioCtx.currentTime + 0.01);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);
                
                oscillator.start(audioCtx.currentTime);
                oscillator.stop(audioCtx.currentTime + duration);
            } catch (error) {
                console.error('Error playing beep:', error);
            }
        }
        
        // Function to show Bootstrap toast notification
        function showToast(title, message, type) {
            // Create toast HTML
            const bgClass = type === 'success' ? 'bg-primary' : type === 'info' ? 'bg-info' : 'bg-danger';
            const toastHtml = `
                <div class="toast align-items-center text-white ${bgClass} border-0" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong>${title}</strong><br>
                            ${message}
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>
            `;
            
            // Get or create toast container
            let toastContainer = document.getElementById('toast-container');
            if (!toastContainer) {
                toastContainer = document.createElement('div');
                toastContainer.id = 'toast-container';
                toastContainer.className = 'toast-container position-fixed top-0 end-0 p-3';
                toastContainer.style.zIndex = '1055';
                document.body.appendChild(toastContainer);
            }
            
            // Add toast to container
            toastContainer.insertAdjacentHTML('beforeend', toastHtml);
            
            // Initialize and show toast
            const toastElement = toastContainer.lastElementChild;
            const delayTime = userTipo === 1 ? 5000 : 4000;
            const toast = new bootstrap.Toast(toastElement, {
                autohide: true,
                delay: delayTime
            });
            toast.show();
            
            // Remove toast element after it's hidden
            toastElement.addEventListener('hidden.bs.toast', function() {
                toastElement.remove();
            });
        }
        
        // Function to add new task to the table dynamically
        function addNewTaskToTable(data) {
            try {
                const tbody = document.querySelector('tbody');
                if (!tbody) {
                    console.error('Table body not found');
                    return;
                }
                
                // Remove "no activities" message if it exists
                const noActivitiesRow = tbody.querySelector('td[colspan]');
                if (noActivitiesRow) {
                    noActivitiesRow.closest('tr').remove();
                }
                
                // Create priority badge
                let priorityBadge = '';
                switch(data.prioridade) {
                    case 'Baixa':
                        priorityBadge = '<span class="badge bg-success">Baixa</span>';
                        break;
                    case 'Média':
                        priorityBadge = '<span class="badge bg-info">Média</span>';
                        break;
                    case 'Alta':
                        priorityBadge = '<span class="badge bg-warning">Alta</span>';
                        break;
                    case 'Crítica':
                        priorityBadge = '<span class="badge bg-danger">Crítica</span>';
                        break;
                    default:
                        priorityBadge = '<span class="badge bg-secondary">' + data.prioridade + '</span>';
                }
                
                // Create status badge
                const statusBadge = '<span class="badge bg-warning">Pendente</span>';
                
                // Create action buttons for admin users
                const actionButtons = userTipo === 1 ? `
                    <a href="/update-status/${data.atividade_id}/Em andamento" class="btn btn-sm btn-primary">Iniciar</a>
                    <a href="/delete-atividade/${data.atividade_id}" class="btn btn-sm btn-outline-danger" onclick="return confirm('Tem certeza que deseja excluir esta atividade? Esta ação não pode ser desfeita.')">Excluir</a>
                ` : '';
                
                // Create new row HTML with the real activity ID
                const newRowHtml = `
                    <tr data-atividade-id="${data.atividade_id}" style="background-color: #e8f5e8; transition: background-color 3s ease;">
                        <td>${data.descricao}</td>
                        <td>${data.local}</td>
                        <td>${data.setor}</td>
                        <td>${data.criado_por_nome}</td>
                        <td>${data.solicitante}</td>
                        <td>${data.atendente}</td>
                        <td>${priorityBadge}</td>
                        <td>${data.data_criada}</td>
                        <td>${data.prazo}</td>
                        <td>${statusBadge}</td>
                        ${userTipo === 1 ? '<td>' + actionButtons + '</td>' : ''}
                    </tr>
                `;
                
                // Add to the top of the table
                tbody.insertAdjacentHTML('afterbegin', newRowHtml);
                
                // Remove the highlight after 3 seconds
                setTimeout(function() {
                    const newRow = document.querySelector(`tr[data-atividade-id="${data.atividade_id}"]`);
                    if (newRow) {
                        newRow.style.backgroundColor = '';
                    }
                }, 3000);
                
                console.log('Added new task to table:', data.descricao);
                
            } catch (error) {
                console.error('Error adding new task to table:', error);
            }
        }
        
        // Function to update task status in the table dynamically
        function updateTaskInTable(data) {
            try {
                // Find the table row for this activity using the data attribute
                const targetRow = document.querySelector(`tr[data-atividade-id="${data.atividade_id}"]`);
                
                if (targetRow) {
                    const cells = targetRow.querySelectorAll('td');
                    
                    // Update status cell (find the cell with badge or status text)
                    let statusCell = null;
                    let atendenteCell = null;
                    let prazoCell = null;
                    
                    cells.forEach(function(cell, index) {
                        // Status cell - contains badge elements
                        if (cell.querySelector('.badge') && 
                            (cell.textContent.includes('Pendente') || 
                             cell.textContent.includes('Em andamento') || 
                             cell.textContent.includes('Concluída'))) {
                            statusCell = cell;
                        }
                        
                        // Based on the table structure, atendente should be around index 5
                        if (index === 5) {
                            atendenteCell = cell;
                        }
                        
                        // Prazo should be around index 8
                        if (index === 8) {
                            prazoCell = cell;
                        }
                    });
                    
                    // Update status
                    if (statusCell) {
                        let badgeClass = '';
                        switch(data.status) {
                            case 'Pendente':
                                badgeClass = 'bg-warning';
                                break;
                            case 'Em andamento':
                                badgeClass = 'bg-primary';
                                break;
                            case 'Concluída':
                                badgeClass = 'bg-success';
                                break;
                            default:
                                badgeClass = 'bg-secondary';
                        }
                        
                        statusCell.innerHTML = `<span class="badge ${badgeClass}">${data.status}</span>`;
                    }
                    
                    // Update atendente if available
                    if (atendenteCell && data.atendente) {
                        atendenteCell.textContent = data.atendente;
                    }
                    
                    // Update prazo if available
                    if (prazoCell && data.prazo) {
                        prazoCell.textContent = data.prazo;
                    }
                    
                    // Add a subtle highlight animation
                    targetRow.style.transition = 'background-color 0.5s ease';
                    targetRow.style.backgroundColor = '#e3f2fd';
                    setTimeout(function() {
                        targetRow.style.backgroundColor = '';
                    }, 2000);
                    
                    console.log('Updated task status in table:', data.status);
                } else {
                    console.log('Task row not found for ID:', data.atividade_id);
                }
            } catch (error) {
                console.error('Error updating task in table:', error);
            }
        }
        
        // Request notification permission on page load
        if ('Notification' in window && Notification.permission === 'default') {
            Notification.requestPermission();
        }
    </script>
    {% endif %}
</body>
</html>